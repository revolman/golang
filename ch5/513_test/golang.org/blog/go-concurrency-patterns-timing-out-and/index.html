
<!DOCTYPE html>
<html lang="en">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-11222381-3"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag("js", new Date());
gtag("config", "UA-11222381-3");
gtag("config", "UA-49880327-6");
</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#00ADD8">
<meta name="description" content="Go is an open source programming language that makes it easy to build simple, reliable, and efficient software.">
<title>Go Concurrency Patterns: Timing out, moving on - The Go Blog</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Work+Sans:600|Roboto:400,700|Source+Code+Pro">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Product+Sans&text=Supported%20by%20Google&display=swap">
<link rel="stylesheet" href="/lib/godoc/style.css">
<link rel="stylesheet" href="/fonts.css">
<link rel="alternate" type="application/atom+xml" title="blog.golang.org - Atom Feed" href="https://blog.golang.org/feed.atom" />
<script>window.initFuncs = [];</script>
<style>
  h1,
  h2,
  h3,
  h4,
  h5,
  h6 {
    font-family: 'Work Sans', sans-serif;
    font-weight: 600;
  }
  h2 {  
    background: none;
    clear: none;
    font-size: 1.5em;
    font-weight: 600;
    line-height: inherit;
    overflow-wrap: normal;
    padding: 0;
  }
  @media print {
    #sidebar { display: none; }
  }
  #sidebar {
    float: right;
    padding-left: 20px;
    width: 40%;
    max-width: 250px;
    background: #f8f9f9;
    margin: 20px 0 20px 20px;
  }
  #sidebar h2 {
    font-size: 1rem;
  }
  #sidebar ul {
    padding: 0;
  }
  #sidebar li {
    list-style-type: none;
  }
  #content .author {
    font-style: italic;
  }
  #content .article {
    margin-bottom: 50px;
  }
  #content .date {
    color: #6e7072;
  }
  #content .tags {
    color: #999;
    font-size: smaller;
  }
  #content .iframe, #content .image {
    margin: 20px;
  }
  #content .title {
    margin: 20px 0;
  }
  #content img {
    max-width: 100%;
  }
  .article[data-slug='/go-fonts'] {
    font-family: Go, sans-serif;
  }
  .article[data-slug='/go-fonts'] pre,
  .article[data-slug='/go-fonts'] code {
    font-family: 'Go Mono', monospace;
  }
</style>
<body class="Site">
  <header class="Header js-header">
    <nav class="Header-nav">
      <a href="https://golang.org"><img class="Header-logo" src="/lib/godoc/images/go-logo-blue.svg" alt="Go"></a>
      <button class="Header-menuButton js-headerMenuButton" aria-label="Main menu" aria-expanded="false">
        <div class="Header-menuButtonInner">
      </button>
      <ul class="Header-menu">
        <li class="Header-menuItem"><a href="https://golang.org/doc/">Documents</a></li>
        <li class="Header-menuItem"><a href="https://golang.org/pkg/">Packages</a></li>
        <li class="Header-menuItem"><a href="https://golang.org/project/">The Project</a></li>
        <li class="Header-menuItem"><a href="https://golang.org/help/">Help</a></li>
        <li class="Header-menuItem"><a href="/">Blog</a></li>
        <li class="Header-menuItem"><a href="https://play.golang.org/">Play</a></li>
        <li class="Header-menuItem Header-menuItem--search">
          <form class="HeaderSearch" role="search" action="https://golang.org/search">
            <input class="HeaderSearch-input"
                  type="search"
                  name="q"
                  placeholder="Search"
                  aria-label="Search"
                  autocapitalize="off"
                  autocomplete="off"
                  autocorrect="off"
                  spellcheck="false"
                  required>
            <button class="HeaderSearch-submit" aria-label="Search">
              <svg class="HeaderSearch-icon" width="24" height="24" viewBox="0 0 24 24"><title>Search</title><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/><path d="M0 0h24v24H0z" fill="none"/></svg>
            </button>
          </form>
        </li>
      </ul>
    </nav>
  </header>

  <main class="Site-content" id="page">
    <div class="container">
      <aside id="sidebar">
        
          
            <h2>Next article</h2>
            <p><a href="/smarttwitter">Real Go Projects: SmartTwitter and web.go</a></p>
          

          
            <h2>Previous article</h2>
            <p><a href="/playground-intro">Introducing the Go Playground</a></p>
          
        

        <h2>Links</h2>
        <ul>
          <li><a href='//golang.org/'>golang.org</a></li>
          <li><a href='//golang.org/doc/install.html'>Install Go</a></li>
          <li><a href='//tour.golang.org/'>A Tour of Go</a></li>
          <li><a href='//golang.org/doc/'>Go Documentation</a></li>
          <li><a href='//groups.google.com/group/golang-nuts'>Go Mailing List</a></li>
          <li><a href='//twitter.com/golang'>Go on Twitter</a></li>
        </ul>

        <p><a href="/index">Blog index</a></p>
      </aside>

      <div id="content">
        <h1><a href="/">The Go Blog</a></h1>
        
	
  <div class="article" data-slug="/concurrency-timeouts">
    <h2 class="title"><a href="/concurrency-timeouts">Go Concurrency Patterns: Timing out, moving on</a></h2>
    <p class="author">
    Andrew Gerrand<br>
    23 September 2010
    </p>
    
  
  
    
      
        <p>Concurrent programming has its own idioms.
A good example is timeouts. Although Go's channels do not support them directly,
they are easy to implement.
Say we want to receive from the channel <code>ch</code>,
but want to wait at most one second for the value to arrive.
We would start by creating a signalling channel and launching a goroutine
that sleeps before sending on the channel:</p>
<pre><code>timeout := make(chan bool, 1)
go func() {
    time.Sleep(1 * time.Second)
    timeout &lt;- true
}()
</code></pre>
<p>We can then use a <code>select</code> statement to receive from either <code>ch</code> or <code>timeout</code>.
If nothing arrives on <code>ch</code> after one second,
the timeout case is selected and the attempt to read from ch is abandoned.</p>
<pre><code>select {
case &lt;-ch:
    // a read from ch has occurred
case &lt;-timeout:
    // the read from ch has timed out
}
</code></pre>
<p>The <code>timeout</code> channel is buffered with space for 1 value,
allowing the timeout goroutine to send to the channel and then exit.
The goroutine doesn't know (or care) whether the value is received.
This means the goroutine won't hang around forever if the <code>ch</code> receive happens
before the timeout is reached.
The <code>timeout</code> channel will eventually be deallocated by the garbage collector.</p>
<p>(In this example we used <code>time.Sleep</code> to demonstrate the mechanics of goroutines and channels.
In real programs you should use <code> [time.After](https://golang.org/pkg/time/#After)</code>,
a function that returns a channel and sends on that channel after the specified duration.)</p>
<p>Let's look at another variation of this pattern.
In this example we have a program that reads from multiple replicated databases simultaneously.
The program needs only one of the answers,
and it should accept the answer that arrives first.</p>
<p>The function <code>Query</code> takes a slice of database connections and a <code>query</code> string.
It queries each of the databases in parallel and returns the first response it receives:</p>
<pre><code>func Query(conns []Conn, query string) Result {
    ch := make(chan Result)
    for _, conn := range conns {
        go func(c Conn) {
            select {
            case ch &lt;- c.DoQuery(query):
            default:
            }
        }(conn)
    }
    return &lt;-ch
}
</code></pre>
<p>In this example, the closure does a non-blocking send,
which it achieves by using the send operation in <code>select</code> statement with a <code>default</code> case.
If the send cannot go through immediately the default case will be selected.
Making the send non-blocking guarantees that none of the goroutines launched
in the loop will hang around.
However, if the result arrives before the main function has made it to the receive,
the send could fail since no one is ready.</p>
<p>This problem is a textbook example of what is known as a <a href="https://en.wikipedia.org/wiki/Race_condition" target="_blank" rel="noopener">race condition</a>,
but the fix is trivial.
We just make sure to buffer the channel <code>ch</code> (by adding the buffer length
as the second argument to <a href="https://golang.org/pkg/builtin/#make" target="_blank" rel="noopener">make</a>),
guaranteeing that the first send has a place to put the value.
This ensures the send will always succeed,
and the first value to arrive will be retrieved regardless of the order of execution.</p>
<p>These two examples demonstrate the simplicity with which Go can express complex interactions between goroutines.</p>

      
    
  

  </div>

	
		<h2>Related articles</h2>
		<ul>
		
			<li><a href="/protobuf-apiv2">A new Go API for Protocol Buffers</a></li>
		
			<li><a href="/go1.13-errors">Working with Errors in Go 1.13</a></li>
		
			<li><a href="/debug-opt">Debugging what you deploy in Go 1.12</a></li>
		
			<li><a href="/h2push">HTTP/2 Server Push</a></li>
		
			<li><a href="/http-tracing">Introducing HTTP Tracing</a></li>
		
			<li><a href="/generate">Generating code</a></li>
		
			<li><a href="/context">Go Concurrency Patterns: Context</a></li>
		
			<li><a href="/pipelines">Go Concurrency Patterns: Pipelines and cancellation</a></li>
		
			<li><a href="/race-detector">Introducing the Go Race Detector</a></li>
		
			<li><a href="/io2013-talk-concurrency">Advanced Go Concurrency Patterns</a></li>
		
			<li><a href="/maps">Go maps in action</a></li>
		
			<li><a href="/gofmt">go fmt your code</a></li>
		
			<li><a href="/waza-talk">Concurrency is not parallelism</a></li>
		
			<li><a href="/organizing-go-code">Organizing Go code</a></li>
		
			<li><a href="/io2012-videos">Go videos from Google I/O 2012</a></li>
		
			<li><a href="/debug-gdb">Debugging Go programs with the GNU Debugger</a></li>
		
			<li><a href="/image-draw">The Go image/draw package</a></li>
		
			<li><a href="/image">The Go image package</a></li>
		
			<li><a href="/laws-of-reflection">The Laws of Reflection</a></li>
		
			<li><a href="/error-handling-and-go">Error handling and Go</a></li>
		
			<li><a href="/functions-codewalk">First Class Functions in Go</a></li>
		
			<li><a href="/pprof">Profiling Go Programs</a></li>
		
			<li><a href="/gif-decoder">A GIF decoder: an exercise in Go interfaces</a></li>
		
			<li><a href="/introducing-gofix">Introducing Gofix</a></li>
		
			<li><a href="/godoc">Godoc: documenting Go code</a></li>
		
			<li><a href="/gob">Gobs of data</a></li>
		
			<li><a href="/cgo">C? Go? Cgo!</a></li>
		
			<li><a href="/json">JSON and Go</a></li>
		
			<li><a href="/slices-intro">Go Slices: usage and internals</a></li>
		
			<li><a href="/defer-panic-and-recover">Defer, Panic, and Recover</a></li>
		
			<li><a href="/codelab-share">Share Memory By Communicating</a></li>
		
			<li><a href="/json-rpc">JSON-RPC: a tale of interfaces</a></li>
		
		</ul>
	

      </div>

    </div>
  </main>

  <footer>
    <div class="Footer">
      <img class="Footer-gopher" src="/lib/godoc/images/footer-gopher.jpg" alt="The Go Gopher">
      <ul class="Footer-links">
        <li class="Footer-link"><a href="https://golang.org/doc/copyright.html">Copyright</a></li>
        <li class="Footer-link"><a href="https://golang.org/doc/tos.html">Terms of Service</a></li>
        <li class="Footer-link"><a href="http://www.google.com/intl/en/policies/privacy/">Privacy Policy</a></li>
        <li class="Footer-link"><a href="http://golang.org/issues/new?title=x/blog:" target="_blank" rel="noopener">Report issue</a></li>
      </ul>
      <a class="Footer-supportedBy" href="https://google.com">Supported by Google</a>
    </div>
  </footer>

  <script src="/lib/godoc/jquery.js"></script>
  <script src="/lib/godoc/playground.js"></script>
  <script src="/lib/godoc/play.js"></script>
  <script src="/lib/godoc/godocs.js"></script>
  <script>
  $(function() {
    
    $('.playground > pre.numbers, .code > pre.numbers').each(function() {
      var $spans = $(this).find('> span');

      
      var max = 0;
      $spans.each(function() {
        var n = $(this).attr('num')*1;
        if (n > max) max = n;
      });
      var width = 2;
      while (max > 10) {
        max = max / 10;
        width++;
      }

      
      $spans.each(function() {
        var n = $(this).attr('num')+' ';
        while (n.length < width) n = ' '+n;
        $('<span class="number">').text(n).insertBefore(this);
      });
    });

    initPlayground(new HTTPTransport());
  });
  </script>
